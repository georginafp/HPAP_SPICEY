---
title: "HPAP CTRL SPICEY"
author: "Georgina Fuentes"
date: "2025-05-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.algn = "center",
                      warning = FALSE,
                      message = FALSE,
                      fig.width=5, 
                      fig.height=5)

## packages
library(GenomicRanges)
library(dplyr)
library(ggplot2)
library(Seurat)
library(tidyr)
library(regioneR)
library(purrr)
library(Signac)
library(purrr)
library(ggside)
library(viridis)
library(tibble)
library(ggsignif)
library(RColorBrewer)
library(ggplotify)
library(pheatmap)
library(patchwork)
library(scales)
library(data.table)
library(here)
library(S4Vectors)
library(ggpubr)
library(ggridges)
library(scales) 
library(tidyverse)
library(org.Hs.eg.db)
library(GenomicFeatures)

## spicey data 
SPICEY_ANNOTATED_COACC <- readRDS("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/data/HPAP_CTRL_SPICEY_COACC.rds")
# hpap <- readRDS("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/data/SUBSET_CTRL_HPAP.rds")

## markers 
# hkg <- fgsea::gmtPathways("/homes/users/gfuentes/scratch/projects/spicey_paper/data/HOUNKPE_HOUSEKEEPING_GENES.v2024.1.Hs.gmt")
# ubiquitous <- hkg$HOUNKPE_HOUSEKEEPING_GENES
hkg <- fgsea::gmtPathways("/homes/users/gfuentes/scratch/projects/spicey_paper/data/HSIAO_HOUSEKEEPING_GENES.v2024.1.Hs.gmt")
ubiquitous <- hkg$HSIAO_HOUSEKEEPING_GENES


# ct_markers <- read.delim("/homes/users/gfuentes/shared_data/refs/hi_populations_markers.txt",
#                          stringsAsFactors=F)

url <- "https://docs.google.com/spreadsheets/d/1bdGW69IXu4Iy9Uinnfjd42xDtR6dkCOmX0B-T0qVxrI/edit?gid=0#gid=0"

get_gsheet <- function(url, sheet) {
  googlesheets4::gs4_deauth()
  googlesheets4::gs4_auth()
  gsheet <- googlesheets4::read_sheet(url, sheet)
  return(gsheet)
}
ct_markers <- get_gsheet(url=url, sheet="LP")
ct_markers <- ct_markers %>%
  data.frame() %>% 
  # mutate(CellType = gsub(" cells", "", CellType),
  #        CellType = gsub("Pancreatic stellate", "Stellate", CellType)) %>%
  # filter(Specie %in% c("Hs", "Mm Hs")) %>%
  # dplyr::select(-c(Specie)) %>%
  dplyr::filter(CellType %in% unique(SPICEY_ANNOTATED_COACC$linked$cell_type))
  


# ct_markers2 <- data.table::fread("/homes/users/gfuentes/shared_data/refs/Islet_important_Motifs.csv")
# ct_markers3 <- data.table::fread("/homes/users/gfuentes/shared_data/refs/PANCREATIC_BETA_GENES_HGNC.txt")
# ct_markers4 <- data.table::fread("/homes/users/gfuentes/shared_data/refs/Pasquali2014_SuppTable2_importantIsletGenes.csv")

# ct_markers <- unique(c(ct_markers$Gene, 
#                        ct_markers3$Symbol, 
#                        ct_markers4$Symbol
#                        ))



## disease 
# disease_paths <- list(
#   T1D = "/homes/users/gfuentes/shared_data/refs/T1D_GWAS_ASSOCIATIONS.tsv",
#   T2D = "/homes/users/gfuentes/shared_data/refs/T2D_GWAS_ASSOCIATIONS.tsv",
#   # LUNG_CANCER = "/homes/users/gfuentes/shared_data/refs/LUNG_CANCER_ASSOCIATIONS.tsv",
#   SCHIZO = "/homes/users/gfuentes/shared_data/refs/SCHIZOFRENIA_ASSOCIATIONS.tsv",
#   RHEUMATOID = "/homes/users/gfuentes/shared_data/refs/RHEUMATOID_ASSOCIATIONS.tsv",
#   PSORIASIS = "/homes/users/gfuentes/shared_data/refs/PSORIASIS_ASSOCIATIONS.tsv"
# )

## palette 
cell_colors <- c("Alpha" = "#008E80",
                 "Ductal" = "#5A7A98",
                 "Beta" = "#D37972",
                 "Delta" = "#fcbbb6",
                 "Acinar" = "#B4609B",
                 "Gamma" = "#C6E6FF",
                 "Stellate" = "#fbb679",
                 #"Quiescent-stellate" = "#ffdd6c",
                 "Unknown" = "#c7c7c7",
                 "Immune" = "#7E9F66",
                 "Epsilon" = "#A3D2CA",
                 "Endothelial" = "#87abbf")

```

```{r run-spicey, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

library(SPICEY)
library(TxDb.Hsapiens.UCSC.hg38.knownGene)
library(org.Hs.eg.db)

atac <- readRDS("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/data/DA_ATAC_HPAP-CTRL.rds")
atac <- setNames(
  lapply(atac, function(x) {
    x <- as.data.frame(x)
    x$region_id <- paste0(x$seqnames, "-", x$start, "-", x$end)
    GenomicRanges::makeGRangesFromDataFrame(x, keep.extra.columns = TRUE)
  }),
  vapply(atac, function(x) unique(as.character(mcols(x)$cell_type)), character(1))
)


rna <- readRDS("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/data/DA_RNA_HPAP-CTRL.rds")
rna <- lapply(rna, function(df) { rownames_to_column(df, var = "gene_id")})

links <- readRDS("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/data/CTRL_LINKS_2.rds") %>%
  dplyr::filter(coaccess > 0.5)

peaks <- unlist(GRangesList(atac))
names(peaks) <- NULL

annotation_near <- annotate_with_nearest(peaks = peaks,
                                         txdb = TxDb.Hsapiens.UCSC.hg38.knownGene,
                                         annot_dbi = org.Hs.eg.db,
                                         protein_coding_only = TRUE,
                                         verbose = TRUE,
                                         add_tss_annotation = FALSE,
                                         upstream = 2000,
                                         downstream = 2000)

annotation_coacc <- annotate_with_coaccessibility(peaks = annotation_near |> 
                                                    dplyr::rename(nearestGeneSymbol = gene_id) |> 
                                                    makeGRangesFromDataFrame(keep.extra.columns = T),
                                                  txdb = TxDb.Hsapiens.UCSC.hg38.knownGene,
                                                  links_df=links,
                                                  annot_dbi = org.Hs.eg.db,
                                                  protein_coding_only = TRUE,
                                                  verbose = TRUE,
                                                  add_tss_annotation = TRUE,
                                                  upstream = 2000,
                                                  downstream = 2000)

SPICEY_ANNOTATED_COACC <- SPICEY(atac=atac, 
                                 region_id = "region_id", 
                                 rna=rna, 
                                 gene_id = "gene_id", 
                                 annotation = annotation_coacc)

saveRDS(SPICEY_ANNOTATED_COACC, "/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/data/HPAP_CTRL_SPICEY_COACC.rds")

```

```{r message=FALSE, warning=FALSE, out.width='1%', umap fig.show='hold'}

knitr::include_graphics("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs/HPAP_UMAP_FINAL.png")

```

# Distribution of SPICEY measures

```{r distrib-spicey, message=FALSE, warning=FALSE, fig.width=6, fig.height=6}

# Prepare long data for SPICEY metrics
spicey_long <- SPICEY_ANNOTATED_COACC$linked %>%
  as.data.frame() %>%
  group_by(gene_id) %>%
  # filter(!(all(RETSI == 0 | is.na(RETSI)) & all(GETSI == 0 | is.na(GETSI)))) %>%
  ungroup() %>%
  pivot_longer(cols = c(RETSI, GETSI), names_to = "metric", values_to = "value") %>%
  filter(!is.na(value))


# Compute combined mean (RETSI + GETSI) for ordering
cell_order <- spicey_long %>%
  group_by(cell_type) %>%
  summarise(mean_value = mean(value, na.rm = TRUE), .groups = "drop") %>%
  arrange(desc(mean_value)) %>%
  pull(cell_type)

# Reorder factor levels
spicey_long <- spicey_long %>%
  mutate(cell_type = factor(cell_type, levels = cell_order))

# Combine and summarize
.markers <- bind_rows(
  SPICEY_ANNOTATED_COACC$linked %>%
  data.frame() %>%
  inner_join(ct_markers %>% dplyr::select(-Source),
             by = c("gene_id" = "Gene", "cell_type" = "CellType")) %>%
  # filter(TSS_gene %in% ct_markers$Gene) %>%
  mutate(type = "Tissue-specific"), 

  SPICEY_ANNOTATED_COACC$linked %>%
  data.frame() %>%
  filter(gene_id %in% ubiquitous) %>%
  mutate(type = "Ubiquitous")
  ) %>%
  mutate(
    type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
    RETSI = as.numeric(RETSI),
    GETSI = as.numeric(GETSI)
  ) %>%
  filter(!is.na(RETSI), !is.na(GETSI)) %>%
  group_by(cell_type, type) %>%
  summarise(
    RETSI = mean(RETSI, na.rm = TRUE),
    GETSI = mean(GETSI, na.rm = TRUE),
    .groups = "drop"
  )




# Count number of cells per cell type (based on hpap annotation)
# cell_counts <- hpap@meta.data %>%
#   data.frame() %>%
#   count(cell_type = RNA_scSorter.Pred_Type.predicted.id) %>%
#   dplyr::filter(cell_type %in% cell_order) %>%
#   mutate(cell_type = factor(cell_type, levels = cell_order))

# Plot 1: Boxplot + jitter + marker dots
distribution <- ggplot(spicey_long, aes(x = cell_type, y = value)) +
  geom_jitter(color = "grey80", width = 0.15, size = 0.4, alpha = 0.05) +
  geom_boxplot(aes(fill = cell_type), position = position_dodge(width = 0.8),
               outlier.shape = NA, linewidth = 0.6, color = "gray45") +
  geom_point(
    data = .markers %>%
      pivot_longer(cols = c(RETSI, GETSI), names_to = "metric", values_to = "value"),
    aes(x = cell_type, y = value, color = type),
    size = 2
  ) +
  scale_color_manual(values = c(
  "Tissue-specific" = "#965819",
  "Ubiquitous" = "#585800"
)) +
  facet_grid(~metric) +
  scale_fill_manual(values = cell_colors) +
  labs(x = "Cell type", y = "SPICEY measure") +
  coord_flip() +
  theme_gray(base_size = 14) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank(),
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12),
    plot.margin = margin(5, 2, 5, 5)
  )

# Plot 2: Barplot of cell counts
# barplot_counts <- ggplot(cell_counts, aes(x = cell_type, y = n, fill = cell_type)) +
#   geom_col(width = 0.6) +
#   scale_fill_manual(values = cell_colors) +
#   coord_flip() +
#   labs(x = NULL, y = "# cells") +
#   theme_gray(base_size = 14) +
#   theme(
#     axis.text.y = element_blank(),  # ← hides y labels
#     axis.ticks.y = element_blank(),
#     axis.title.x = element_text(size = 10),
#     legend.position = "none",
#     panel.grid.minor = element_blank(),
#     axis.title = element_text(size = 10, margin = margin(t = 5)),
#     axis.text = element_text(size = 8, margin = margin(t = 2)),
#     axis.text.x = element_text(angle = 45, hjust = 1),
#     strip.text = element_text(size = 8),
#     plot.title = element_text(size = 12),
#     plot.margin = margin(5, 5, 5, 2)  # top, right, bottom, left
#   )

# # Combine plots side by side
# distribution_counts <- distribution + barplot_counts +
#   plot_layout(ncol = 2, widths = c(2, 0.5))

# distribution

distribution <- cowplot::plot_grid(distribution,                                  
                                   labels = c("A"), 
                                   label_size = 12)
distribution

ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/SPICEY_distribution.png"),
       plot = distribution, width = 5, height = 3.5, units = "in", dpi = 300)

```

# Distribution markers

```{r markers-tss, message=FALSE, warning=FALSE}

prom <- bind_rows(
  # Tissue-specific
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    inner_join(ct_markers %>% dplyr::select(-Source),
               by = c("gene_id" = "Gene", "cell_type" = "CellType")) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")
) %>%
  mutate(
    type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
    RETSI = as.numeric(RETSI),
    GETSI = as.numeric(GETSI)
  ) %>%
  filter(!is.na(RETSI), !is.na(GETSI), !is.na(type)) %>%
  pivot_longer(cols = c(RETSI, GETSI),
               names_to = "spicey_measure",
               values_to = "value") %>%
  # Apply conditional TSS filters *only for RETSI*
  filter(
    spicey_measure != "RETSI" |
      (type == "Tissue-specific" & TSS_gene %in% ct_markers$Gene & annotation == "Promoter" |
      (type == "Ubiquitous" & TSS_gene %in% ubiquitous & annotation == "Promoter")
  )) %>%
  mutate(
    color_key = paste(type, spicey_measure, sep = "_")
  ) %>%
  ggplot(aes(x = value, color = color_key, fill = color_key)) +
  geom_density(alpha = 0.6) +
  ggside::geom_xsideboxplot(aes(y = spicey_measure, fill = color_key), 
                            orientation = "y", outlier.size = 0.1, 
                            outlier.alpha = 0.5) +
  ggside::scale_xsidey_discrete() +
  scale_y_continuous(name = "Density") +
  scale_color_manual(values = c(
    "Ubiquitous_RETSI" = "#656d4a",
    "Ubiquitous_GETSI" = "#5e614b",
    "Tissue-specific_RETSI" = "#b37a56",
    "Tissue-specific_GETSI" = "#8c5e3c"
  )) +
  scale_fill_manual(values = c(
    "Ubiquitous_RETSI" = "#a4ac86",
    "Ubiquitous_GETSI" = "#919b74",
    "Tissue-specific_RETSI" = "#D2B48C",
    "Tissue-specific_GETSI" = "#c8a77b"
  )) +
  labs(x = "SPICEY measure") +
  theme_gray() +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    strip.text = element_text(size = 8),
    axis.text.x = element_text(angle = 30),
    plot.title = element_text(size = 12)
  ) +
  facet_grid(~ type) +
  ggtitle("Promoter")



enh <- bind_rows(
  # Tissue-specific: match by gene and cell type, keep all rows
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    # filter(direct_TSS == TRUE) %>%
    inner_join(ct_markers %>% dplyr::select(-Source),
               by = c("gene_id" = "Gene", "cell_type" = "CellType")) %>%
    mutate(type = "Tissue-specific") %>%
    filter(gene_id %in% ct_markers$Gene),
  
  # Ubiquitous: just filter by gene list
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  
  # Factor level for consistency in plotting
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(!is.na(RETSI), !is.na(GETSI), !is.na(type)) %>%
  # mutate(region = paste0(seqnames, ":", start, "-", end)) %>%
  pivot_longer(cols = c(RETSI, GETSI),
               names_to = "spicey_measure",
               values_to = "value") %>% 
  filter(
    spicey_measure != "RETSI" |
    (annotation == "Distal")) %>%
  mutate(
    color_key = paste(type, spicey_measure, sep = "_")
  ) %>%
  ggplot(aes(x = value, color = color_key, fill = color_key)) +
  geom_density(alpha = 0.6) +
  ggside::geom_xsideboxplot(aes(y = spicey_measure, fill = color_key), 
                            orientation = "y", outlier.size = 0.1, 
                            outlier.alpha = 0.5) +
  ggside::scale_xsidey_discrete() +
  scale_y_continuous(name = "Density") +
  scale_color_manual(values = c(
    "Ubiquitous_RETSI" = "#656d4a",
    "Ubiquitous_GETSI" = "#5e614b",
    "Tissue-specific_RETSI" = "#b37a56",
    "Tissue-specific_GETSI" = "#8c5e3c"
  )) +
  scale_fill_manual(values = c(
    "Ubiquitous_RETSI" = "#a4ac86",
    "Ubiquitous_GETSI" = "#919b74",
    "Tissue-specific_RETSI" = "#D2B48C",
    "Tissue-specific_GETSI" = "#c8a77b"
  )) +
  
  labs(x = "SPICEY measure") +
  # ggtitle("Promoter regions") +
  theme_gray() +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),  # smaller top margin
    axis.text = element_text(size = 8, margin = margin(t = 2)),   # bring x-ticks closer
    strip.text = element_text(size = 8),
    axis.text.x = element_text(angle=30),
    plot.title = element_text(size = 12)
  ) +
  facet_grid(~ type) +
  ggtitle("Distal")


final <- cowplot::plot_grid(prom, enh,                                  
                            labels = c("B", "C"), 
                            label_size = 12)

ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/SPICEY_MARKERS.png"),
       plot = last_plot(), width = 6, height = 3.5, units = "in", dpi = 300)


## all----
# all <- bind_rows(
#   # Tissue-specific: match by gene and cell type, keep all rows
#   SPICEY_ANNOTATED_COACC$linked %>%
#     data.frame() %>%
#     # filter(direct_TSS == TRUE) %>%
#     inner_join(ct_markers %>% dplyr::select(-Source),
#                by = c("gene_id" = "Gene", "cell_type" = "CellType")) %>%
#     mutate(type = "Tissue-specific") %>%
#     filter(gene_id %in% ct_markers$Gene),
#   
#   # Ubiquitous: just filter by gene list
#   SPICEY_ANNOTATED_COACC$linked %>%
#     data.frame() %>%
#     filter(gene_id %in% ubiquitous) %>%
#     mutate(type = "Ubiquitous")) %>%
#   
#   # Factor level for consistency in plotting
#   mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
#          RETSI = as.numeric(RETSI),
#          GETSI = as.numeric(GETSI)) %>%
#   filter(!is.na(RETSI), !is.na(GETSI), !is.na(type)) %>%
#   # mutate(region = paste0(seqnames, ":", start, "-", end)) %>%
#   pivot_longer(cols = c(RETSI, GETSI),
#                names_to = "spicey_measure",
#                values_to = "value") %>% 
#   # filter(
#   #   spicey_measure != "RETSI" |
#   #   (annotation == "Distal")) %>%
#   mutate(
#     color_key = paste(type, spicey_measure, sep = "_")
#   ) %>%
#   ggplot(aes(x = value, color = color_key, fill = color_key)) +
#   geom_density(alpha = 0.6) +
#   ggside::geom_xsideboxplot(aes(y = spicey_measure, fill = color_key), 
#                             orientation = "y", outlier.size = 0.1, 
#                             outlier.alpha = 0.5) +
#   ggside::scale_xsidey_discrete() +
#   scale_y_continuous(name = "Density") +
#   scale_color_manual(values = c(
#     "Ubiquitous_RETSI" = "#656d4a",
#     "Ubiquitous_GETSI" = "#5e614b",
#     "Tissue-specific_RETSI" = "#b37a56",
#     "Tissue-specific_GETSI" = "#8c5e3c"
#   )) +
#   scale_fill_manual(values = c(
#     "Ubiquitous_RETSI" = "#a4ac86",
#     "Ubiquitous_GETSI" = "#919b74",
#     "Tissue-specific_RETSI" = "#D2B48C",
#     "Tissue-specific_GETSI" = "#c8a77b"
#   )) +
#   
#   labs(x = "SPICEY measure") +
#   # ggtitle("Promoter regions") +
#   theme_gray() +
#   theme(
#     legend.position = "none",
#     ggside.panel.scale.x = 0.3,
#     axis.title = element_text(size = 10, margin = margin(t = 5)),  # smaller top margin
#     axis.text = element_text(size = 8, margin = margin(t = 2)),   # bring x-ticks closer
#     strip.text = element_text(size = 8),
#     axis.text.x = element_text(angle=30),
#     plot.title = element_text(size = 12)
#   ) +
#   facet_grid(~ type)
# 
# all

```

# Entropy 

```{r entropy, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# all -------------------------------------------------------------------------
entropy <- bind_rows(
  # Tissue-specific data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ct_markers$Gene) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(
    !is.na(RETSI),
    !is.na(GETSI),
    !is.na(type)) %>%
  {rownames(.) <- NULL; .} %>%
  filter(!is.na(GETSI),
         !is.na(RETSI)) %>%
  pivot_longer(cols = c(RETSI_entropy, GETSI_entropy),
               names_to = "spicey_measure",
               values_to = "value") %>%
  mutate(spicey_measure = gsub("_entropy", "", spicey_measure)) %>%
  ggplot(aes(x = type,
             y = value,
             fill = type)) +
  geom_violin() +
  geom_boxplot(alpha = 0.4) +  # Adjust outlier behavior if needed
  theme_gray() +
  labs(x = "", y = "Entropy") +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12)
  ) +
  scale_fill_manual(values = c(
    "Ubiquitous" = "#919b74",
    "Tissue-specific" = "#c8a77b"
  )) +
  # ylim(c(1,1.2))+
  geom_signif(comparisons = list(
    c("Tissue-specific", "Ubiquitous")),
    y_position = c(1, 1.1),  # Adjust y position for annotations
    map_signif_level = TRUE,  # Display significance level
    textsize = 2.3,
    vjust = 0.01,               # Moves text slightly above the line
    tip_length = 0.02         # Negative value to flip arrows **upwards**
  ) +
  facet_grid(~spicey_measure) 

ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/ENTROPY_PROM_MARKERS.png"),
       plot = entropy, width = 4.5, height = 4, units = "in", dpi = 300)
entropy <- cowplot::plot_grid(entropy,                                  
                              labels = c("D"), 
                              label_size = 12)

# split  -------------------------------------------------------------------------
entropy_prom <- bind_rows(
  # Tissue-specific data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ct_markers$Gene) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(
    !is.na(RETSI),
    !is.na(GETSI),
    !is.na(type)) %>%
  {rownames(.) <- NULL; .} %>%
  filter(!is.na(GETSI),
         !is.na(RETSI)) %>%
  pivot_longer(cols = c(RETSI_entropy, GETSI_entropy),
               names_to = "spicey_measure",
               values_to = "value") %>%
  # Apply conditional TSS filters *only for RETSI*
  filter(
    spicey_measure != "RETSI" |
      (type == "Tissue-specific" & TSS_gene %in% ct_markers$Gene & annotation == "Promoter" |
      (type == "Ubiquitous" & TSS_gene %in% ubiquitous & annotation == "Promoter")
  )) %>%
  mutate(spicey_measure = gsub("_entropy", "", spicey_measure)) %>%
  ggplot(aes(x = type,
             y = value,
             fill = type)) +
  geom_violin() +
  geom_boxplot(alpha = 0.4) +  # Adjust outlier behavior if needed
  theme_gray() +
  labs(x = "", y = "Entropy") +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12)
  ) +
  scale_fill_manual(values = c(
    "Ubiquitous" = "#919b74",
    "Tissue-specific" = "#c8a77b"
  )) +
  # ylim(c(1,1.2))+
  geom_signif(comparisons = list(
    c("Tissue-specific", "Ubiquitous")),
    y_position = c(1, 1.1),  # Adjust y position for annotations
    map_signif_level = TRUE,  # Display significance level
    textsize = 2.3,
    vjust = 0.01,               # Moves text slightly above the line
    tip_length = 0.02         # Negative value to flip arrows **upwards**
  ) +
  facet_grid(~spicey_measure) +
  ggtitle("Promoter")


entropy_distal <- bind_rows(
  # Tissue-specific data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ct_markers$Gene) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(
    !is.na(RETSI),
    !is.na(GETSI),
    !is.na(type)) %>%
  {rownames(.) <- NULL; .} %>%
  filter(!is.na(GETSI),
         !is.na(RETSI)) %>%
  pivot_longer(cols = c(RETSI_entropy, GETSI_entropy),
               names_to = "spicey_measure",
               values_to = "value") %>%
  mutate(spicey_measure = gsub("_entropy", "", spicey_measure)) %>%
  # Apply conditional TSS filters *only for RETSI*
  filter(
    spicey_measure != "RETSI" |
    (annotation == "Distal")) %>%
  ggplot(aes(x = type,
             y = value,
             fill = type)) +
  geom_violin() +
  geom_boxplot(alpha = 0.4) +  # Adjust outlier behavior if needed
  theme_gray() +
  labs(x = "", y = "Entropy") +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12)
  ) +
  scale_fill_manual(values = c(
    "Ubiquitous" = "#919b74",
    "Tissue-specific" = "#c8a77b"
  )) +
  # ylim(c(1,1.2))+
  geom_signif(comparisons = list(
    c("Tissue-specific", "Ubiquitous")),
    y_position = c(1, 1.1),  # Adjust y position for annotations
    map_signif_level = TRUE,  # Display significance level
    textsize = 2.3,
    vjust = 0.01,               # Moves text slightly above the line
    tip_length = 0.02         # Negative value to flip arrows **upwards**
  ) +
  facet_grid(~spicey_measure) +
  ggtitle("Distal")


final_ENT <- cowplot::plot_grid(entropy_prom, entropy_distal,                                  
                                labels = c("A", "B"), 
                                label_size = 12)

ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/ENTROPY_MARKERS.png"),
       plot = final_ENT, width = 5.5, height = 3.5, units = "in", dpi = 300)


```

```{r entropy-split, message=FALSE, warning=FALSE}

## getsi H ----
entropy_genes <- bind_rows(
  # Tissue-specific data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ct_markers$Gene) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(
    !is.na(RETSI),
    !is.na(GETSI),
    !is.na(type)) %>%
  {rownames(.) <- NULL; .} %>%
  filter(!is.na(GETSI),
         !is.na(RETSI)) %>%
  pivot_longer(cols = c(GETSI_entropy),
               names_to = "spicey_measure",
               values_to = "value") %>%
  mutate(spicey_measure = gsub("_entropy", "", spicey_measure)) %>%
  ggplot(aes(x = type,
             y = value,
             fill = type)) +
  geom_violin() +
  geom_boxplot(alpha = 0.4) +  # Adjust outlier behavior if needed
  theme_gray() +
  labs(x = "", y = "Entropy") +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12)
  ) +
  scale_fill_manual(values = c(
    "Ubiquitous" = "#919b74",
    "Tissue-specific" = "#c8a77b"
  )) +
  # ylim(c(1,1.2))+
  geom_signif(comparisons = list(
    c("Tissue-specific", "Ubiquitous")),
    y_position = c(1, 1.1),  # Adjust y position for annotations
    map_signif_level = TRUE,  # Display significance level
    textsize = 2.3,
    vjust = 0.01,               # Moves text slightly above the line
    tip_length = 0.02         # Negative value to flip arrows **upwards**
  )

g_entropy <- cowplot::plot_grid(entropy_genes,
                                labels = c("D"),
                                label_size = 12)

## retsi H ----
entropy_prom <- bind_rows(
  # Tissue-specific data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ct_markers$Gene) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(
    !is.na(RETSI),
    !is.na(GETSI),
    !is.na(type)) %>%
  {rownames(.) <- NULL; .} %>%
  filter(!is.na(GETSI),
         !is.na(RETSI)) %>%
  pivot_longer(cols = c(RETSI_entropy),
               names_to = "spicey_measure",
               values_to = "value") %>%
  # Apply conditional TSS filters *only for RETSI*
  filter(
    spicey_measure != "RETSI" |
      (type == "Tissue-specific" & TSS_gene %in% ct_markers$Gene & annotation == "Promoter" |
         (type == "Ubiquitous" & TSS_gene %in% ubiquitous & annotation == "Promoter")
      )) %>%
  mutate(spicey_measure = gsub("_entropy", "", spicey_measure)) %>%
  ggplot(aes(x = type,
             y = value,
             fill = type)) +
  geom_violin() +
  geom_boxplot(alpha = 0.4) +  # Adjust outlier behavior if needed
  theme_gray() +
  labs(x = "", y = "Entropy") +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12)
  ) +
  scale_fill_manual(values = c(
    "Ubiquitous" = "#919b74",
    "Tissue-specific" = "#c8a77b"
  )) +
  # ylim(c(1,1.2))+
  geom_signif(comparisons = list(
    c("Tissue-specific", "Ubiquitous")),
    y_position = c(1, 1.1),  # Adjust y position for annotations
    map_signif_level = TRUE,  # Display significance level
    textsize = 2.3,
    vjust = 0.01,               # Moves text slightly above the line
    tip_length = 0.02         # Negative value to flip arrows **upwards**
  ) +
  # facet_grid(~spicey_measure) +
  ggtitle("Promoter")


entropy_distal <- bind_rows(
  # Tissue-specific data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ct_markers$Gene) %>%
    mutate(type = "Tissue-specific"),
  
  # Ubiquitous data
  SPICEY_ANNOTATED_COACC$linked %>%
    data.frame() %>%
    dplyr::filter(gene_id %in% ubiquitous) %>%
    mutate(type = "Ubiquitous")) %>%
  mutate(type = factor(type, levels = c("Ubiquitous", "Tissue-specific")),
         RETSI = as.numeric(RETSI),
         GETSI = as.numeric(GETSI)) %>%
  filter(
    !is.na(RETSI),
    !is.na(GETSI),
    !is.na(type)) %>%
  {rownames(.) <- NULL; .} %>%
  filter(!is.na(GETSI),
         !is.na(RETSI)) %>%
  pivot_longer(cols = c(RETSI_entropy),
               names_to = "spicey_measure",
               values_to = "value") %>%
  mutate(spicey_measure = gsub("_entropy", "", spicey_measure)) %>%
  # Apply conditional TSS filters *only for RETSI*
  filter(
    spicey_measure != "RETSI" |
      (annotation == "Distal")) %>%
  ggplot(aes(x = type,
             y = value,
             fill = type)) +
  geom_violin() +
  geom_boxplot(alpha = 0.4) +  # Adjust outlier behavior if needed
  theme_gray() +
  labs(x = "", y = "Entropy") +
  theme(
    legend.position = "none",
    ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 10, margin = margin(t = 5)),
    axis.text = element_text(size = 8, margin = margin(t = 2)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(size = 8),
    plot.title = element_text(size = 12)
  ) +
  scale_fill_manual(values = c(
    "Ubiquitous" = "#919b74",
    "Tissue-specific" = "#c8a77b"
  )) +
  # ylim(c(1,1.2))+
  geom_signif(comparisons = list(
    c("Tissue-specific", "Ubiquitous")),
    y_position = c(1, 1.1),  # Adjust y position for annotations
    map_signif_level = TRUE,  # Display significance level
    textsize = 2.3,
    vjust = 0.01,               # Moves text slightly above the line
    tip_length = 0.02         # Negative value to flip arrows **upwards**
  ) +
  # facet_grid(~spicey_measure) +
  ggtitle("Distal")


r_entropy <- cowplot::plot_grid(entropy_prom, entropy_distal,
                                labels = c("E"),
                                label_size = 12)


entropy_final <- cowplot::plot_grid(g_entropy, 
                                    r_entropy, 
                                    label_size = 12, 
                                    rel_widths = c(.6, 1)

```


# Main figure

```{r final-figure, message=FALSE, warning=FALSE, fig.width=5, fig.height=9}

## Combine plots
# bottom_row <- cowplot::plot_grid(prom, enh,
#                                  labels = c("B", "C"),
#                                  label_size = 12,
#                                  ncol = 2)

# Make a narrower entropy plot by putting it in a row with a spacer
entropy_row <- cowplot::plot_grid(
  entropy, NULL, NULL,
  rel_widths = c(0.9, 0.3, 0.3),  # Center the entropy plot
  nrow = 1
)

# Now combine all three rows
final_plot <- cowplot::plot_grid(
  distribution,
  final,
  entropy_final,
  nrow = 3,
  rel_heights = c(1, 1, 1.2)  # Slightly less vertical height for the entropy row
)

ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/FINAL_FIGURE.png"),
       plot = final_plot, width = 5, height = 9, units = "in", dpi = 300)

final_plot

```

# Heatmap 

```{r main-heatmap, message=FALSE, warning=FALSE}

# Step 1: Compute combined z-scores and select top genes per cell type
top_retsi <- SPICEY_ANNOTATED_COACC$linked %>%
  data.frame() %>%
  filter(!is.na(RETSI), 
         !is.na(GETSI), 
         !is.na(gene_id) 
         # in_TSS == TRUE, 
         # annotation == "Promoter"
         ) %>%
  mutate(GETSI_z = scale(GETSI)[, 1],
         RETSI_z = scale(RETSI)[, 1],
         combined_score = (RETSI_z + GETSI_z) / 2) %>%
  group_by(cell_type) %>%
  arrange(desc(combined_score)) %>%
  distinct(cell_type, gene_id, .keep_all = TRUE) %>%
  slice_head(n = 5) %>%
  ungroup()

# Step 2: Get the unique genes selected
selected_genes <- unique(top_retsi$gene_id)

# Step 3: Create long-format data for selected genes across all cell types
heatmap_df <- SPICEY_ANNOTATED_COACC$linked %>%
  data.frame() %>%
  # filter(in_TSS == TRUE, 
  #         annotation == "Promoter") %>%
  filter(gene_id %in% selected_genes) %>%
  filter(!is.na(RETSI), !is.na(GETSI)) %>%
  mutate(
    GETSI_z = scale(GETSI)[, 1],
    RETSI_z = scale(RETSI)[, 1],
    combined_score = (RETSI_z + GETSI_z) / 2
  ) %>%
  dplyr::select(gene_id, cell_type, combined_score) %>%
  group_by(gene_id, cell_type) %>%
  summarise(combined_score = mean(combined_score), .groups = "drop")

# Step 4: Order genes by their max cell type for better row sorting
wide_mat <- heatmap_df %>%
  pivot_wider(names_from = cell_type, values_from = combined_score, values_fill = 0) %>%
  column_to_rownames("gene_id") %>%
  as.matrix()

gene_order_df <- data.frame(
  gene_id = rownames(wide_mat),
  max_cell_type = colnames(wide_mat)[apply(wide_mat, 1, which.max)],
  max_score = apply(wide_mat, 1, max)
) %>%
  arrange(max_cell_type, desc(max_score))

ordered_genes <- gene_order_df$gene_id

# Step 5: Plot heatmap
heatmap_df$gene_id <- factor(heatmap_df$gene_id, levels = ordered_genes)

gene_colors <- ifelse(levels(heatmap_df$gene_id) %in% 
                        ct_markers$Gene, "#965819", "grey30")
custom_colors <- c(
  "white",
  # "#F8E3E0", 
  "#E18C80", #"#CA6D5F", 
  "#B86357", #"#84473E", 
  "#723D36", #"#60342D", 
  "#4F2A25" #"#3D211D"
)


ggplot(heatmap_df, aes(x = cell_type, y = gene_id, fill = combined_score)) +
  geom_tile(color = "grey80", width = 0.95) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  coord_fixed(ratio = 0.5) +
  scale_fill_gradientn(
    colours = custom_colors,
    # limits = c(0, 1),
    name = paste0("SPICEY \nz-score"),
    na.value = "grey90") +
  theme_gray() +
  guides(fill = guide_colourbar(barwidth = 0.5, barheight = 4)) +  # Smaller legend bar
  theme(
    legend.title=element_text(size=7),
    legend.text = element_text(size=7),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
    axis.text.y = element_text(size = 7, color = gene_colors),
    panel.grid = element_blank(),
    # ggside.panel.scale.x = 0.3,
    axis.title = element_text(size = 7),
    axis.text = element_text(size = 7),
    strip.text = element_text(size = 7),
    plot.title = element_text(size = 7)) +
  labs(
    x = "Cell type",
    y = "Gene")

ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/SPICEY_heatmap.png"),
       plot = last_plot(), width = 3, height = 7, units = "in", dpi = 300)

```

```{r spicey-heatmap, message=FALSE, warning=FALSE}

SPICEY::spicey_heatmap(df = SPICEY_ANNOTATED_COACC$linked, 
                       spicey_measure = c("SPICEY"), 
                       combined_zscore = TRUE, 
                       top_n = 5)
ggsave(paste0(here::here("/homes/users/gfuentes/scratch/projects/spicey_paper/HPAP_CTRL/figs"), "/SPICEY_heatmap.png"),
       plot = last_plot(), width = 3, height = 7, units = "in", dpi = 300)
```


